<!DOCTYPE html>
<html lang="en-US">

<head>
    <title>GW2 Reset Timer &amp; countdown</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" integrity="sha384-L1dWfspMTHU/ApYnFiMz2QID/PlP1xCW9visvBdbEkOLkSSWsP6ZJWhPw6apiXxU" crossorigin="anonymous">
</head>

<body>
    <main class="container">
        <h1>GW2 Reset Timer &amp; countdown</h1>
        <div class="grid">
            <div>
                <h2>Daily Reset</h2>
                <div>Next: <span id="next-daily"></span></div>
                <div>In: <span id="daily-countdown"></span></div>
            </div>
            <div>
                <h2>Weekly Reset</h2>
                <div>Next: <span id="next-weekly"></span></div>
                <div>In: <span id="weekly-countdown"></span></div>
            </div>
            <div>
                <h2>WVW Reset</h2>
                <div>Next: <span id="next-wvw"></span></div>
                <div>In: <span id="wvw-countdown"></span></div>
            </div>
        </div>
        <div height="200px">&nbsp;</div>
        <small>
            We think your:
            <ul>
                <li>Timezone is: <span id="timezone"></span></li>
                <li>Current time is now <span id="current"></span></li>
            </ul>
            But we could be dumb.<br /> So if you need to adjust the time. you can do so here:
            <fieldset>
                <label>
                    <input name="negative" type="checkbox" role="switch" onchange="updateOffset" />
                    Negative offset
                </label>
            </fieldset>
            <fieldset class="grid">
                <label>Hour: <input name="hours" type="number" min="0" max="23" placeholder="hours" value="0"></label>
                <label>Minutes: <input name="minutes" type="number" min="0" max="59" placeholder="minutes" value="0"></label>
            </fieldset>
        </small>

    </main>
</body>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js" integrity="sha256-nP25Pzivzy0Har7NZtMr/TODzfGWdlTrwmomYF2vQXM=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/plugin/utc.js" integrity="sha256-qDfIIxqpRhYWa543p6AHZ323xT3B8O6iLZFUAWtEQJw=" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/plugin/isoWeek.js" integrity="sha256-mTe29uf4Uv0YCnXQLyIymKRUGozsQV0Mra1d/efUCSk=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/plugin/timezone.js" integrity="sha256-qChvIvJkeTbV5m0C0KrBl+sOicaIklgEk82lwpDSkZE=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/plugin/localizedFormat.js" integrity="sha256-g+gxm1xmRq4IecSRujv2eKyUCo/i1b5kRnWNcSbYEO0=" crossorigin="anonymous"></script>
<script>
    "use strict"
    dayjs.extend(window.dayjs_plugin_utc);
    dayjs.extend(window.dayjs_plugin_timezone);
    dayjs.extend(window.dayjs_plugin_isoWeek);
    dayjs.extend(window.dayjs_plugin_localizedFormat);
    let totalOffset = 0;
    
    function select(selector) {
        const doc = document.querySelectorAll(selector);
        if (doc.length > 0) {
            return doc[0];
        }
        return {
            "innerText": "",
            "value": null
        };
    }
    
    function updateOffset() {
        let hours = select('[name=hours]').value || '0';
        let minutes = select('[name=minutes]').value || '0';
        let negative = select('[name=negative]').checked;
        try {
            hours = parseInt(hours);
        } catch (e) {
            hours = 0;
            select('[name=hours]').value = '0';
        }
        try {
            minutes = parseInt(minutes);
        } catch (e) {
            minutes = 0;
            select('[name=minutes]').value = '0';
        }
        totalOffset = (hours * 60 + minutes) * (negative ? -1 : 1);
    }
    select('[name=hours]').addEventListener('keyup', updateOffset);
    select('[name=hours]').addEventListener('change', updateOffset);
    select('[name=minutes]').addEventListener('keyup', updateOffset);
    select('[name=minutes]').addEventListener('change', updateOffset);
    select('[name=negative]').addEventListener('change', updateOffset);
    const tz = dayjs.tz.guess();
    select('#timezone').innerText = tz;

    function diff(day1, day2) {
        const d = day1.diff(day2)
        const seconds = Math.floor(d / 1000);
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        const output = [];
        if (days > 0) {
            output.push(`${days}d`);
        }
        if (hours > 0 || days > 0) {
            output.push(`${hours}h`);
        }
        if (hours > 0 || days > 0 || minutes > 0) {
            output.push(`${minutes}m`);
        }
        output.push(`${secs}s`);
        return output.join(' ');
    }
    function showNext(tz) {
        const now = dayjs.utc().add(totalOffset, 'minutes');
        select('#current').innerText = now.tz(tz).format('lll');
        let dailyReset = dayjs.utc().startOf('day');
        if (now.isAfter(dailyReset)) {
            dailyReset = dailyReset.add(1, 'day');
        }
        select('#next-daily').innerText = dailyReset.tz(tz).format('D MMM YYYY, h:mm A');
        select('#daily-countdown').innerText = diff(dailyReset, now);

        let weekyReset = dayjs.utc().startOf('isoWeek').add('7.5', 'hours');
        if (now.isAfter(weekyReset)) {
            weekyReset = weekyReset.add(1, 'week');
        }
        select('#next-weekly').innerText = weekyReset.tz(tz).format('D MMM YYYY, h:mm A');
        select('#weekly-countdown').innerText = diff(weekyReset, now);

        let wvwReset = dayjs.utc().startOf('isoWeek').add(5 * 24 + 2, 'hours');
        if (now.isAfter(wvwReset)) {
            wvwReset = wvwReset.add(1, 'week');
        }
        select('#next-wvw').innerText = wvwReset.tz(tz).format('D MMM YYYY, h:mm A');
        select('#wvw-countdown').innerText = diff(wvwReset, now);
        window.setTimeout(showNext, 1000 / 3);
    }
    showNext(tz);
</script>

</html>
